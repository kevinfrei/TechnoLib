<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Generated by javadoc (17) -->
    <title>Source code</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="source: package: com.technototes.path.subsystem, class: DistanceSensorLocalizer"
    />
    <meta name="generator" content="javadoc/SourceToHTMLConverter" />
    <link
      rel="stylesheet"
      type="text/css"
      href="../../../../../stylesheet.css"
      title="Style"
    />
  </head>
  <body class="source-page">
    <main role="main">
      <div class="source-container">
        <pre><span class="source-line-no">001</span><span id="line-1">package com.technototes.path.subsystem;</span>
<span class="source-line-no">002</span><span id="line-2"></span>
<span class="source-line-no">003</span><span id="line-3">import androidx.annotation.NonNull;</span>
<span class="source-line-no">004</span><span id="line-4">import androidx.annotation.Nullable;</span>
<span class="source-line-no">005</span><span id="line-5"></span>
<span class="source-line-no">006</span><span id="line-6">import java.util.Map;</span>
<span class="source-line-no">007</span><span id="line-7"></span>
<span class="source-line-no">008</span><span id="line-8">import com.acmerobotics.roadrunner.geometry.Pose2d;</span>
<span class="source-line-no">009</span><span id="line-9">import com.acmerobotics.roadrunner.localization.Localizer;</span>
<span class="source-line-no">010</span><span id="line-10">import com.acmerobotics.roadrunner.util.Angle;</span>
<span class="source-line-no">011</span><span id="line-11"></span>
<span class="source-line-no">012</span><span id="line-12">import com.technototes.library.hardware.sensor.IDistanceSensor;</span>
<span class="source-line-no">013</span><span id="line-13">import com.technototes.library.hardware.sensor.IGyro;</span>
<span class="source-line-no">014</span><span id="line-14">import com.technototes.library.subsystem.Subsystem;</span>
<span class="source-line-no">015</span><span id="line-15">import com.technototes.library.util.MathUtils;</span>
<span class="source-line-no">016</span><span id="line-16"></span>
<span class="source-line-no">017</span><span id="line-17">public class DistanceSensorLocalizer implements Localizer, Subsystem {</span>
<span class="source-line-no">018</span><span id="line-18"></span>
<span class="source-line-no">019</span><span id="line-19">    private Pose2d poseEstimate;</span>
<span class="source-line-no">020</span><span id="line-20"></span>
<span class="source-line-no">021</span><span id="line-21">    private final double maxSensorDistance = 40;</span>
<span class="source-line-no">022</span><span id="line-22"></span>
<span class="source-line-no">023</span><span id="line-23">    private final Map&lt;IDistanceSensor, Pose2d&gt; sensorMap;</span>
<span class="source-line-no">024</span><span id="line-24">    private final IGyro gyro;</span>
<span class="source-line-no">025</span><span id="line-25"></span>
<span class="source-line-no">026</span><span id="line-26">    public DistanceSensorLocalizer(IGyro g, Map&lt;IDistanceSensor, Pose2d&gt; map) {</span>
<span class="source-line-no">027</span><span id="line-27">        gyro = g;</span>
<span class="source-line-no">028</span><span id="line-28">        sensorMap = map;</span>
<span class="source-line-no">029</span><span id="line-29">        poseEstimate = new Pose2d();</span>
<span class="source-line-no">030</span><span id="line-30">    }</span>
<span class="source-line-no">031</span><span id="line-31"></span>
<span class="source-line-no">032</span><span id="line-32">    @NonNull @Override</span>
<span class="source-line-no">033</span><span id="line-33">    public Pose2d getPoseEstimate() {</span>
<span class="source-line-no">034</span><span id="line-34">        return poseEstimate;</span>
<span class="source-line-no">035</span><span id="line-35">    }</span>
<span class="source-line-no">036</span><span id="line-36"></span>
<span class="source-line-no">037</span><span id="line-37">    @Override</span>
<span class="source-line-no">038</span><span id="line-38">    public void setPoseEstimate(@NonNull Pose2d pose2d) {</span>
<span class="source-line-no">039</span><span id="line-39">        poseEstimate = pose2d;</span>
<span class="source-line-no">040</span><span id="line-40">    }</span>
<span class="source-line-no">041</span><span id="line-41"></span>
<span class="source-line-no">042</span><span id="line-42">    @Nullable @Override</span>
<span class="source-line-no">043</span><span id="line-43">    public Pose2d getPoseVelocity() {</span>
<span class="source-line-no">044</span><span id="line-44">        return null;</span>
<span class="source-line-no">045</span><span id="line-45">    }</span>
<span class="source-line-no">046</span><span id="line-46"></span>
<span class="source-line-no">047</span><span id="line-47">    @Override</span>
<span class="source-line-no">048</span><span id="line-48">    public void update() {</span>
<span class="source-line-no">049</span><span id="line-49">        update(null);</span>
<span class="source-line-no">050</span><span id="line-50">    }</span>
<span class="source-line-no">051</span><span id="line-51"></span>
<span class="source-line-no">052</span><span id="line-52">    public void update(@Nullable Pose2d old) {</span>
<span class="source-line-no">053</span><span id="line-53">        double heading = getHeading();</span>
<span class="source-line-no">054</span><span id="line-54">        double accumX = 0, accumY = 0;</span>
<span class="source-line-no">055</span><span id="line-55">        int totalX = 0, totalY = 0;</span>
<span class="source-line-no">056</span><span id="line-56">        for (Map.Entry&lt;IDistanceSensor, Pose2d&gt; entry : sensorMap.entrySet()) {</span>
<span class="source-line-no">057</span><span id="line-57">            IDistanceSensor sensor = entry.getKey();</span>
<span class="source-line-no">058</span><span id="line-58">            Pose2d sensorPose = entry.getValue();</span>
<span class="source-line-no">059</span><span id="line-59">            double distance = sensor.getDistance();</span>
<span class="source-line-no">060</span><span id="line-60">            if (distance &lt; maxSensorDistance &amp;&amp; distance &gt; 0.5) {</span>
<span class="source-line-no">061</span><span id="line-61">                sensorPose =</span>
<span class="source-line-no">062</span><span id="line-62">                        new Pose2d(sensorPose.vec().rotated(heading), Angle.norm(sensorPose.getHeading() + heading));</span>
<span class="source-line-no">063</span><span id="line-63">                double change;</span>
<span class="source-line-no">064</span><span id="line-64">                switch (MathUtils.closestTo(2 * sensorPose.getHeading() / Math.PI, 0, 1, 2, 3, 4)) {</span>
<span class="source-line-no">065</span><span id="line-65">                    case 0:</span>
<span class="source-line-no">066</span><span id="line-66">                    case 4:</span>
<span class="source-line-no">067</span><span id="line-67">                        change = 71 - sensorPose.getX() - Math.cos(sensorPose.getHeading()) * distance;</span>
<span class="source-line-no">068</span><span id="line-68">                        if (old != null &amp;&amp; Math.abs(old.getX() - change) &gt; 10) break;</span>
<span class="source-line-no">069</span><span id="line-69">                        accumX += change;</span>
<span class="source-line-no">070</span><span id="line-70">                        totalX++;</span>
<span class="source-line-no">071</span><span id="line-71">                        break;</span>
<span class="source-line-no">072</span><span id="line-72">                    case 1:</span>
<span class="source-line-no">073</span><span id="line-73">                        change = 71 - sensorPose.getY() - Math.sin(sensorPose.getHeading()) * distance;</span>
<span class="source-line-no">074</span><span id="line-74">                        if (old != null &amp;&amp; Math.abs(old.getY() - change) &gt; 10) break;</span>
<span class="source-line-no">075</span><span id="line-75">                        accumY += change;</span>
<span class="source-line-no">076</span><span id="line-76">                        totalY++;</span>
<span class="source-line-no">077</span><span id="line-77">                        break;</span>
<span class="source-line-no">078</span><span id="line-78">                    case 2:</span>
<span class="source-line-no">079</span><span id="line-79">                        change = 71 + sensorPose.getX() + Math.cos(sensorPose.getHeading()) * distance;</span>
<span class="source-line-no">080</span><span id="line-80">                        if (old != null &amp;&amp; Math.abs(old.getX() + change) &gt; 10) break;</span>
<span class="source-line-no">081</span><span id="line-81">                        accumX -= change;</span>
<span class="source-line-no">082</span><span id="line-82">                        totalX++;</span>
<span class="source-line-no">083</span><span id="line-83">                        break;</span>
<span class="source-line-no">084</span><span id="line-84">                    case 3:</span>
<span class="source-line-no">085</span><span id="line-85">                        change = 71 + sensorPose.getY() + Math.sin(sensorPose.getHeading()) * distance;</span>
<span class="source-line-no">086</span><span id="line-86">                        if (old != null &amp;&amp; Math.abs(old.getY() + change) &gt; 10) break;</span>
<span class="source-line-no">087</span><span id="line-87">                        accumY -= change;</span>
<span class="source-line-no">088</span><span id="line-88">                        totalY++;</span>
<span class="source-line-no">089</span><span id="line-89">                        break;</span>
<span class="source-line-no">090</span><span id="line-90">                }</span>
<span class="source-line-no">091</span><span id="line-91">            }</span>
<span class="source-line-no">092</span><span id="line-92">        }</span>
<span class="source-line-no">093</span><span id="line-93">        if (old == null) old = new Pose2d();</span>
<span class="source-line-no">094</span><span id="line-94">        poseEstimate = new Pose2d(</span>
<span class="source-line-no">095</span><span id="line-95">                totalX != 0 ? accumX / totalX : old.getX(), totalY != 0 ? accumY / totalY : old.getY(), heading);</span>
<span class="source-line-no">096</span><span id="line-96">    }</span>
<span class="source-line-no">097</span><span id="line-97"></span>
<span class="source-line-no">098</span><span id="line-98">    public double gyroOffset = 0;</span>
<span class="source-line-no">099</span><span id="line-99"></span>
<span class="source-line-no">100</span><span id="line-100">    public void setGyroOffset(double v) {</span>
<span class="source-line-no">101</span><span id="line-101">        gyroOffset = v;</span>
<span class="source-line-no">102</span><span id="line-102">    }</span>
<span class="source-line-no">103</span><span id="line-103"></span>
<span class="source-line-no">104</span><span id="line-104">    public double getHeading() {</span>
<span class="source-line-no">105</span><span id="line-105">        return Angle.norm(gyro.gyroHeadingInRadians() - gyroOffset);</span>
<span class="source-line-no">106</span><span id="line-106">    }</span>
<span class="source-line-no">107</span><span id="line-107">}</span>




























































</pre>
      </div>
    </main>
  </body>
</html>
